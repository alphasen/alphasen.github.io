<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>你不知道JavaScript 第二卷</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.7f06094c.css" as="style"><link rel="preload" href="/assets/js/app.87d94ce0.js" as="script"><link rel="preload" href="/assets/js/2.58eaf8be.js" as="script"><link rel="preload" href="/assets/js/14.b056a73a.js" as="script"><link rel="preload" href="/assets/js/3.f2a5cb00.js" as="script"><link rel="prefetch" href="/assets/js/10.7be5d1ae.js"><link rel="prefetch" href="/assets/js/11.2f28fa00.js"><link rel="prefetch" href="/assets/js/12.7222b1f1.js"><link rel="prefetch" href="/assets/js/13.e4a3df77.js"><link rel="prefetch" href="/assets/js/15.49856cb4.js"><link rel="prefetch" href="/assets/js/16.f4425947.js"><link rel="prefetch" href="/assets/js/17.33e280fa.js"><link rel="prefetch" href="/assets/js/18.3a61f332.js"><link rel="prefetch" href="/assets/js/19.00f8b91c.js"><link rel="prefetch" href="/assets/js/20.e8beb5b5.js"><link rel="prefetch" href="/assets/js/21.2166c3ea.js"><link rel="prefetch" href="/assets/js/22.0b419ae3.js"><link rel="prefetch" href="/assets/js/23.776cd046.js"><link rel="prefetch" href="/assets/js/24.4756b9c2.js"><link rel="prefetch" href="/assets/js/25.5ea267cb.js"><link rel="prefetch" href="/assets/js/26.61782855.js"><link rel="prefetch" href="/assets/js/27.670be8ef.js"><link rel="prefetch" href="/assets/js/28.b506e69e.js"><link rel="prefetch" href="/assets/js/4.b408d12e.js"><link rel="prefetch" href="/assets/js/5.40b2e56c.js"><link rel="prefetch" href="/assets/js/6.ffab53b5.js"><link rel="prefetch" href="/assets/js/7.8f488cb5.js"><link rel="prefetch" href="/assets/js/8.dac88724.js"><link rel="prefetch" href="/assets/js/9.c72da658.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7f06094c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nav.1.javascript/" class="nav-link router-link-active">
  Javascript
</a></div><div class="nav-item"><a href="/nav.2.algorithm/" class="nav-link">
  Algorithm
</a></div><div class="nav-item"><a href="/nav.3.react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/nav.4.vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/nav.5.typescript/" class="nav-link">
  Typescript
</a></div><div class="nav-item"><a href="/nav.6.webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/nav.7.other/" class="nav-link">
  Other
</a></div><div class="nav-item"><a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Devdocs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nav.1.javascript/" class="nav-link router-link-active">
  Javascript
</a></div><div class="nav-item"><a href="/nav.2.algorithm/" class="nav-link">
  Algorithm
</a></div><div class="nav-item"><a href="/nav.3.react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/nav.4.vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/nav.5.typescript/" class="nav-link">
  Typescript
</a></div><div class="nav-item"><a href="/nav.6.webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/nav.7.other/" class="nav-link">
  Other
</a></div><div class="nav-item"><a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Devdocs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/nav.1.javascript/" aria-current="page" class="sidebar-link">JavaScript学习</a></li><li><a href="/nav.1.javascript/promise.html" class="sidebar-link">Promise</a></li><li><a href="/nav.1.javascript/作用域链.html" class="sidebar-link">JavaScript 深入之作用域链</a></li><li><a href="/nav.1.javascript/你不知道的JavaScript.html" class="sidebar-link">你不知道的JavaScript</a></li><li><a href="/nav.1.javascript/你不知道的JavaScript上.html" class="sidebar-link">你不知道的JavaScript上</a></li><li><a href="/nav.1.javascript/你不知道的JavaScript中.html" class="active sidebar-link">你不知道JavaScript 第二卷</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nav.1.javascript/你不知道的JavaScript中.html#promise" class="sidebar-link">Promise</a></li><li class="sidebar-sub-header"><a href="/nav.1.javascript/你不知道的JavaScript中.html#promise模式" class="sidebar-link">Promise模式</a></li><li class="sidebar-sub-header"><a href="/nav.1.javascript/你不知道的JavaScript中.html#生成器" class="sidebar-link">生成器</a></li><li class="sidebar-sub-header"><a href="/nav.1.javascript/你不知道的JavaScript中.html#性能" class="sidebar-link">性能</a></li></ul></li><li><a href="/nav.1.javascript/原型链.html" class="sidebar-link">原型链</a></li><li><a href="/nav.1.javascript/变脸对象.html" class="sidebar-link">JavaScript 深入之变量对象</a></li><li><a href="/nav.1.javascript/执行上下文.html" class="sidebar-link">执行上下文</a></li><li><a href="/nav.1.javascript/词法作用域.html" class="sidebar-link">词法作用域</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="你不知道javascript-第二卷"><a href="#你不知道javascript-第二卷" class="header-anchor">#</a> 你不知道JavaScript 第二卷</h1> <h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <h3 id="回调函数模式存在的问题"><a href="#回调函数模式存在的问题" class="header-anchor">#</a> 回调函数模式存在的问题</h3> <ol><li>回调过早</li> <li>回调过晚(或不被调用)</li> <li>调用次数过多或过少</li> <li>未能传递所需的环境和参数</li> <li>吞掉可能出现的错误和异常</li></ol> <h4 id="promise可以避免以上这些问题"><a href="#promise可以避免以上这些问题" class="header-anchor">#</a> Promise可以避免以上这些问题</h4> <ol><li><p>回调过早：对一个Promise调用then(..)的时候，即使该Promise已经完成，then的回调也会被异步调用，也就是不会出现调用过早的问题</p></li> <li><p>调用过晚或未调用</p> <ol><li>调用过晚： 一个Promise完成以后会对它上面注册的then(..)事件依次调用，任何一个回调都无法影响或延误这种链式调用<div class="language-javascript extra-class"><pre class="language-javascript"><code></code></pre></div></li></ol> <p>var p=new Promise((resolve)=&gt;resolve())
// 输出的一定是 a b c
p.then(function(){
p.then(function(){
console.log('c')
})
console.log('a')
})
p.then(function(){
console.log('b')
})</p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div></li> <li><p>未调用：没有任何东西能阻止Promise在完成时向外层通知它的决议，错误也不行，如果对一个Promise注册了完成回调和拒绝回调，那么总有一个会被调用，即使回调函数本身出错，回调的错误也不会被吞掉</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>    <span class="token comment">// 避免永远不会完成的Promise 也就是设置超时的方法</span>
    <span class="token keyword">let</span> <span class="token function-variable function">timeoutPromise</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">delay</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>delay<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token function-variable function">foo</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">timeoutPromise</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">suc</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>suc<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>调用次数过少或过多：回调被正确调用的次数是1，调用次数过少就是没有调用，上面已经分析过了，也给了解决办法</p> <ol><li><p>过多的情况：Promise的定义方式使得它只会被决议一次(即resolve或reject一次)，后续的调用resolve或reject会被忽略。由于其只会被决议一次，所以任何通过then注册的回调都只会被调用一次。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 如果像下面这样一个回调被注册了两次，那么它会被调用两次，但这是由用户决定的(或者是用户的编码错误导致)</span>
<span class="token keyword">var</span> p<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> <span class="token function-variable function">thenP</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>thenP<span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>thenP<span class="token punctuation">)</span>
</code></pre></div></li></ol></li> <li><p>未能传递参数/环境值：跟回调函数方式一样，Promise的then注册函数保有其注册地方的闭包，所以也是可以访问环境变量的。(这并不是Promise独有的优点，回调函数方式也是有的)</p> <blockquote><p>注意：resolve 和 reject 函数传入的参数，只接收第一个参数，后续的参数将会被忽略(多个值的时候可以使用对象或数组)</p></blockquote></li> <li><p>吞掉错误和异常：Promise在创建过程中或查看结果的过程中的任何节点产生了异常，都会相当于调用了reject(..)</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> errPromise<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>xxx<span class="token punctuation">.</span>xxx<span class="token punctuation">)</span> <span class="token comment">// xxx 未定义 会抛出referenceError</span>
errPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tongbu'</span><span class="token punctuation">)</span>  <span class="token comment">// 出错可能会引起同步响应</span>



<span class="token comment">// 这种在then里产生的异常不会对 promise产生任何影响</span>
</code></pre></div></li></ol> <h4 id="链式流"><a href="#链式流" class="header-anchor">#</a> 链式流</h4> <blockquote><p>每次对Promise调用then(..),它都会创建并返回一个新的Promise。</p> <p>不管从then中调用的完成回调返回的值是什么，它都会被自动设置为Promise中的完成</p></blockquote> <ol><li><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> p<span class="token operator">=</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 返回一个完成态的Promise</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token operator">=&gt;</span>num<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>传递给Promise.resolve(也就是then函数的第一个回调的处理完成调用)的是一个Promise时会直接将该Promise返回，如果是一个thenable对象，会将其展开</p></li> <li><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// sleep 延时的实现方式</span>
<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>then调用链中的reject处理函数，会将整条链'重置'为正常的运作状态</p></li> <li><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> p<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>notExits<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我捕捉到了错误哈'</span><span class="token punctuation">,</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">22</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 上面一步的reject处理函数将整条then调用链矫正回了正常的流程中</span>

<span class="token keyword">var</span> p<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>notExits<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">var</span> m<span class="token operator">=</span>p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我捕获了错误'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
m<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
m<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>如果Promise的then只出传入一个完成处理函数，那么默认的错误处理函数就会顶上来(其实这个错误处理函数会直接将改错误抛出，直到遇到显式定义的拒绝处理函数)</p></li> <li><p>then(null,err=&gt;{})，这种形式只会处理错误，当没有错误发生时，直接将值交由后续的Promise处理</p></li> <li><p>总结：</p> <ol><li>调用Promise的then会自动创建一个新的Promise</li> <li>在完成或拒绝处理函数内部，如果返回一个值或抛出一个异常，新返回的Promise就相应的决议</li> <li>如果完成或拒绝处理函数返回一个Promise，它将会被展开，不管它返回什么，都会成为当前then返回的链接Promise的决议值</li></ol></li></ol> <h4 id="链式流-2"><a href="#链式流-2" class="header-anchor">#</a> 链式流</h4> <ol><li><p>Promise.resolve(..) 会将传入的真正 Promise 直接返回，对传
入的 thenable 则会展开。如果这个 thenable 展开得到一个拒绝状态，那么从 Promise.
resolve(..) 返回的 Promise 实际上就是这同一个拒绝状态。Promise.resolve(..) 是一个精确的好名字，因为它实际上的结果可能是完成或拒绝。</p></li> <li><p>reject(..) 不会像 resolve(..) 一样进行展开。如果向
reject(..) 传入一个 Promise/thenable 值，它会把这个值原封不动地设置为
拒绝理由。后续的拒绝处理函数接收到的是你实际传给 reject(..) 的那个
Promise/thenable，而不是其底层的立即值。</p></li></ol> <h4 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h4> <ol><li><p>error-first 模式： 将错误置到回调函数的第一个参数，强迫回调进行错误处理</p></li> <li><p>分离回调模式：两个回调，分别处理成功和失败的情况 Promise 的错误处理易于出错。这非常容易造成错误被吞掉，而这极少是出于你的本意。</p> <ol><li><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 经试验 新版的node和浏览器已经可以捕获这种情况了(垃圾回收机制，追踪Promise对象，如果在它被回收的时候其中有拒绝，浏览器能够确保这是一个真正的未捕获错误，进而可以将其报告到开发者终端)</span>
<span class="token keyword">var</span> p<span class="token operator">=</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span> <span class="token comment">// err not handled</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'catch'</span><span class="token punctuation">,</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// catch 的回调函数里如果出现错误，这个错误也是未捕获的</span>
</code></pre></div></li></ol></li></ol> <h2 id="promise模式"><a href="#promise模式" class="header-anchor">#</a> Promise模式</h2> <h3 id="promise-all"><a href="#promise-all" class="header-anchor">#</a> Promise.all()</h3> <p>经典的编程术语中，门(gate)是这样一种机制要等待两个或更多并行 / 并发的任务都完成才能继续,他们的完成顺序不重要，但是必须都要完成，门才能打开并让流程控制继续。在Promise中这种模式被称为all([...])</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 传给 Promise.all([ .. ]) 的数组中的值可以是 Promise、 thenable，甚至是立即值。就本质而言，列表中的每个值都会通过 Promise. resolve(..) 过滤，以确保要等待的是一个真正的 Promise，所以立即值会 被规范化为为这个值构建的 Promise。如果数组是空的，主 Promise 就会立 即完成。</span>
<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1/&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2/&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">msgs</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'some url'</span><span class="token operator">+</span>msgs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>如果这些promise中有任何一个被拒绝的话，主Promise.all([ .. ])promise就会立
即被拒绝，并丢弃来自其他所有 promise 的全部结果。</p> <p>永远要记住为每个promise关联一个拒绝/错误处理函数，特别是从Promise.all([ .. ])
返回的那一个。</p> <h3 id="promise-race"><a href="#promise-race" class="header-anchor">#</a> Promise.race([...])</h3> <blockquote><p>永远不要传入空数组，否则其永远不会结束</p></blockquote> <p>接受单个数组参数。这个数组由一个或多个Promise、thenable或立即值组成。立即值之间的竞争在实践中没有太大意义，因为显然列表中的第一个会获胜，就像赛跑中有一个选手是从终点开始比赛一样.</p> <p>一旦有任何一个Promise决议为完成，Promise.race([ .. ])就会完成;一旦有任何一个 Promise 决议为拒绝，它就会拒绝。</p> <p>如果你传入了一个空数组，主race([..]) Promise 永远不会决议，而不是立即决议。这很容易搬起石头砸自己的脚! ES6 应该指定它完成或拒绝，抑或只是抛出某种同步错误。遗憾的是，因为 Promise 库在时间上早于 ES6 Promise，它们不得已遗留了这个问题，所以，要注意，永远不要递送空数组。</p> <ol><li>finally (新版浏览器已经支持,node从10版本开始已经支持该特性)
<ol><li>这个回调在 Promise 决议后总是会被调用，并且允许你执行任何必要的清理工作用于处理Promise结束后的清理工作</li></ol></li></ol> <h3 id="promise-api"><a href="#promise-api" class="header-anchor">#</a> Promise API</h3> <h4 id="promise-resolve和promise-reject"><a href="#promise-resolve和promise-reject" class="header-anchor">#</a> Promise.resolve和Promise.reject</h4> <ol><li>如果不了解属性的值，可以直接使用Promise.resolve,如果它恰好是一个Promise，是不会有任何开销的，如果不是一个Promise，它会将其包装或展开为一个Promise</li> <li>都会展开thenable对象</li></ol> <h4 id="then-和catch"><a href="#then-和catch" class="header-anchor">#</a> then()和catch()</h4> <ol><li>then可以为Promise注册完成和拒绝处理函数，Promise决议之后，立即会调用这两个处理函数之一，但不会两个都调用，而且总是异步调用</li> <li>默认完成回调只是把消息传递下去，而默认拒绝回调则只是重新抛出(传播)其接收到的出错原因</li> <li>catch(..) 只接受一个拒绝回调作为参数，并自动替换默认完成回调。换句话说，它等价于 then(null,..)</li> <li>then(..) 和 catch(..) 也会创建并返回一个新的 promise，这个 promise 可以用于实现Promise 链式流程控制。如果完成或拒绝回调中抛出异常，返回的 promise 是被拒绝的。如果任意一个回调返回非 Promise、非 thenable 的立即值，这个值会被用作返回 promise 的完成值。如果完成处理函数返回一个 promise 或 thenable，那么这个值会被展开，并作为返回promise 的决议值。</li></ol> <h4 id="promise-all-和promise-race"><a href="#promise-all-和promise-race" class="header-anchor">#</a> Promise.all([])和Promise.race([...])</h4> <p>Promise.all 相当于门概念，Promise.race相当于门闩</p> <h2 id="生成器"><a href="#生成器" class="header-anchor">#</a> 生成器</h2> <p>生成器就是一类特殊的函数，可以一次货多次的启动和停止，并不一定非得要完成</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> x<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 生成器</span>
  x<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'x:'</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  x<span class="token operator">++</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it<span class="token operator">=</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 并没有执行foo生成器，而只是构造了一个迭代器，这个迭代器会控制他的执行</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 启动了生成器 并运行了foo的第一行 这个 next(..) 调用的结果是一个对象，它有一个 value 属性，持有从 *foo(..) 返回的值</span>
x <span class="token comment">// 2</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// x会递增</span>
x <span class="token comment">// 3</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 让生成器从暂停状态恢复执行，输出x的值</span>

</code></pre></div><ol><li><p>迭代消息传递</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> res<span class="token operator">=</span>num<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span> <span class="token comment">// 第二次调用next(..)传进来的值会替换掉yield</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
<span class="token keyword">var</span> it<span class="token operator">=</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment">// 启动生成器</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> res<span class="token operator">=</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>yield可以向外发送消息：(消息是双向传递的)</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// yield 和 next 组合可以双向传递消息</span>
<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> y<span class="token operator">=</span>x<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token punctuation">{</span><span class="token literal-property property">hello</span><span class="token operator">:</span><span class="token string">'world'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> y
<span class="token punctuation">}</span>
<span class="token keyword">var</span> it<span class="token operator">=</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> hello<span class="token operator">=</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// hello:{value:{hello:'world'},done:false}</span>
<span class="token keyword">var</span> res<span class="token operator">=</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>	<span class="token comment">// res:{value:9,done:true}</span>
</code></pre></div><ol start="3"><li>多个迭代器：迭代器控制的是生成器的实例</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> z<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> x<span class="token operator">=</span><span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
  z<span class="token operator">++</span>
  <span class="token keyword">var</span> y<span class="token operator">=</span><span class="token keyword">yield</span> <span class="token punctuation">(</span>x<span class="token operator">*</span>z<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> it1<span class="token operator">=</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> it2<span class="token operator">=</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> val1<span class="token operator">=</span>it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment">// 2</span>
<span class="token keyword">var</span> val2<span class="token operator">=</span>it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment">//2</span>

var1<span class="token operator">=</span>it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>val2<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment">// 40</span>
var2<span class="token operator">=</span>it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>val1<span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment">// 600</span>

it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>val2<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 300  // 20 300 3</span>
it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>val1<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// 10	// 200 10 3</span>
</code></pre></div></li></ol> <h3 id="生成器产生值"><a href="#生成器产生值" class="header-anchor">#</a> 生成器产生值</h3> <h4 id="生产者与迭代器"><a href="#生产者与迭代器" class="header-anchor">#</a> 生产者与迭代器</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 计数器实现</span>
<span class="token keyword">var</span> remerberSomthing<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> val<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">num<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
      val<span class="token operator">=</span><span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      val<span class="token operator">+=</span>num
    <span class="token punctuation">}</span>
  <span class="token keyword">return</span> val
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">remerberSomthing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">remerberSomthing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">remerberSomthing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="生成器迭代器"><a href="#生成器迭代器" class="header-anchor">#</a> 生成器迭代器</h4> <p>严格来说，生成器本身并不是iterable，尽管非常类似—当你执行一个生成器，就得到了一个迭代器</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 生成器实现的计数器</span>
<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> nextVal<span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>nextVal<span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      nextVal<span class="token operator">=</span><span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      nextVal<span class="token operator">+=</span><span class="token number">2</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">yield</span> nextVal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> v <span class="token keyword">of</span> <span class="token function">something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 1 3 5 7 ...</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 如果在生成器内有try...finally语句，它将总是会被调用</span>
<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> val<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
        val<span class="token operator">=</span><span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        val<span class="token operator">+=</span><span class="token number">3</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">yield</span> val
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">finally</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'cleaning up'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> it<span class="token operator">=</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> v <span class="token keyword">of</span> it<span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    it<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 1 4 7 ... cleaning up 'end'</span>
</code></pre></div><h3 id="异步迭代生成器"><a href="#异步迭代生成器" class="header-anchor">#</a> 异步迭代生成器</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 生成器 yield 暂停的特性意味着我们不仅能够从异步函数调用得到看似同步的返回值，还 可以同步捕获来自这些异步函数调用的错误!</span>
<span class="token keyword">function</span> <span class="token function">getFoo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  ajax<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://www.baidu.com&amp;c='</span><span class="token operator">+</span>x<span class="token operator">+</span>y<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
      it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">doAjax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> foo<span class="token operator">=</span><span class="token keyword">yield</span> <span class="token function">getFoo</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> it<span class="token operator">=</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 启动</span>
</code></pre></div><h3 id="生成器-promise"><a href="#生成器-promise" class="header-anchor">#</a> 生成器+Promise</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">,</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token function">fuc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> text<span class="token operator">=</span><span class="token keyword">await</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="性能"><a href="#性能" class="header-anchor">#</a> 性能</h2></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/nav.1.javascript/你不知道的JavaScript上.html" class="prev">
        你不知道的JavaScript上
      </a></span> <span class="next"><a href="/nav.1.javascript/原型链.html">
        原型链
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.87d94ce0.js" defer></script><script src="/assets/js/2.58eaf8be.js" defer></script><script src="/assets/js/14.b056a73a.js" defer></script><script src="/assets/js/3.f2a5cb00.js" defer></script>
  </body>
</html>
